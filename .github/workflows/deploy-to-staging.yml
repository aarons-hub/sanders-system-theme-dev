name: Deploy to Staging v1.0.1

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      staging_repo:
        description: "Staging repository (owner/repo)"
        required: false
        default: "aarons-hub/sanders-system-theme-staging"

jobs:
  deploy:
    name: Deploy Theme to Staging
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Set staging repository
        id: set-staging-repo
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.production_repo }}" ]; then
            echo "repo=${{ github.event. inputs.production_repo }}" >> $GITHUB_OUTPUT
          else
            # Default staging repository
            echo "repo=${{ vars. PRODUCTION_REPO || 'aarons-hub/sanders-system-theme-staging' }}" >> $GITHUB_OUTPUT
          fi

      - name: Remove existing staging directory (if any)
        run: |
          if [ -d "staging" ]; then
            echo "Removing existing staging directory..."
            rm -rf staging
          fi

      - name: Clone staging repository
        env:
          DEV_REPO_TOKEN: ${{ secrets.DEV_REPO_TOKEN }}
        run: |
          if [ -z "$DEV_REPO_TOKEN" ]; then
            echo "Error: DEV_REPO_TOKEN secret is not set"
            echo "Please configure this secret in repository settings with a PAT that has 'repo' scope"
            exit 1
          fi

          REPO="${{ steps.set-staging-repo.outputs.repo }}"

          # Configure git credential helper to avoid token exposure in process list
          git config --global credential.helper store
          echo "https://x-access-token:${DEV_REPO_TOKEN}@github.com" > ~/.git-credentials
          git clone https://github.com/${REPO}.git staging
          CLONE_EXIT_CODE=$?
          if [ $CLONE_EXIT_CODE -ne 0 ]; then
            echo "Error: Failed to clone staging repository ${REPO}"
            exit $CLONE_EXIT_CODE
          fi

      - name: Get staging commit info
        id: staging-commit
        run: |
          cd staging
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
            echo "message=$(git log -1 --pretty=%B | head -n 1)" >> $GITHUB_OUTPUT
          else
            echo "sha=none" >> $GITHUB_OUTPUT
            echo "message=No commits yet" >> $GITHUB_OUTPUT
          fi

      - name: Deployment summary
        if: success()
        run: |
          echo "## Deployment Successful!  :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Commit:** ${{ steps.staging-commit.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Repository:** ${{ steps.set-staging-repo.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

            - name: Deployment failure notification
              if: failure()
              run: |
                echo "## Deployment Failed :x:" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
                echo "**Dev Commit:** ${{ steps.dev-commit.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
                echo "**Staging Repository:** ${{ steps.staging-repo.outputs.repo }}" >> $GITHUB_STEP_SUMMARY
